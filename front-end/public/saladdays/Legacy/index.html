<script type="text/javascript" charset="utf-8">
	/**********
	 * CONSTANTS
	 */
	var debug = true;
	var alwaysOpen=false;
	var closedToday=false;
	var normalHour=false;
	var closedText="";
	var workflowValidated = false;
	//var webkitContentEditing = 'WebkitAppearance' in document.documentElement.style;
	var webkitContentEditing = false;
	var appVersion = '2014.09.01';
	var appLatestVersion = '2014.12.26';
	var parentId = "21"; //SaladDays
	var restaurantName = "";
	var restaurantId = "21"; //SaladDays
	//var restaurantId = "22"; //SaladDays - Deloitte
	var restaurants = [];
	restaurants.push(restaurantId);
</script>
<!--<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.min.js"></script>-->
<!--<script type="text/javascript" src="https://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>-->
<!--<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />-->
<!--<script type="text/javascript"  src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>-->
<script type="text/javascript" charset="utf-8">

	try {
		/**********
		 * CONSTANTS
		 */
		var DELIVERY = "Delivery";
		var TAKEAWAY = "TakeAway";

		/**********
		 * CONSTANTS
		 */
		var comCookedSpeciallyImagePattern = /\/static\/\d+\//;
		var comCookedSpeciallyImagePrefix = "";
		var comCookedSpeciallyApiPrefix = "http://www.stage.cookedspecially.com/CookedSpecially";
//var comCookedSpeciallyApiPrefix = "http://localhost:8080/CookedSpecially";
		var mediaWidth = (window.innerWidth > 0) ? window.innerWidth : screen.width;
		var isPhone = (window.matchMedia('(max-device-width: 568px)').matches);

// temporary hack
		var serverName = location.hostname + ":" + location.port;

		var db;
		var strConnectionAlert = "You appear to be online, but we have a connection problem. Please click Ok to try to download today's menu again.";
		var strOfflineAlert = "You appear to be offline. Please go online and click Ok to download today's menu.";

		var changeCount = 0;
		var menuCount = 0;

		/* *********
		 * GLOBALS
		 */
		var globalMenuIndex = 0; // counter to see if we even have more that one menu at all
		var initialHash = "#restaurants";
		var initialURL = window.location.protocol + "//" + window.location.host + window.location.pathname + window.location.search;
		var restaurantsParamMatch = /\[[0-9,]+?\]/;
		var overallTotal = 0;
		var customerInfo = {};
		var customerId = "";
		var customerEmail = "";
		var customerPhone = "";
		var customerDeliveryTime="00:00";
		var customerName = "";
		var customerAddress1 = "";
		var customerAddress2 = "";
		var outcircleCustomerPhone="";
		var emailMatch = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;
		var phoneMatch = /^(\+[\d]{1,3}|0)?[7-9]\d{9}$/;
		var phoneClean = /[.-]/g;
		var custIdParam = "";
		var restaurantDataString = "";
		var restaurantData = [];
		var globalDataString = "";
		var globalData = [];
		var startTimes;
		var endTime;
		var loadingTime;
// Preloading images -- http://engineeredweb.com/blog/09/12/preloading-images-jquery-and-javascript/
		var preloadCache = [];
		var currency ='&#x20B9;'; // Indian rupee (&#x20B9;)
		var orderItemCount = 0;
		var orderItemCountArray = [];
		var myHistory = [];
		var checks = {1:null, 8:null};
		var chooseLocationPrompt = "Choose a delivery location";
		var chooseDeliveryTime ="Choose Delivery Time";
		var deliveryCharges=0;

// APIs
		var _getTables  = '/CookedSpecially/seatingTable/getRestaurantTables.json?',
				_setTable   = '/CookedSpecially/seatingTable/setStatus?',
				_custInfo   = '/CookedSpecially/customer/getCustomerInfo.json?restaurantId=' + parentId + '&',
				_deliveryAreaInfo   = '/CookedSpecially/restaurant/getDeliveryAreas?',
				_setDeliveryArea   = '/CookedSpecially/order/setDeliveryArea?',
				_setCustInfo   = '/CookedSpecially/customer/setCustomerInfo.json?',
				_getCheck   = '/CookedSpecially/order/getCheckWithOrders.json?',
				_addToCheck = '/CookedSpecially/order/addToCheck.json?',
				_payOnline='/CookedSpecially/restaurant/redirectToPayTm?';
		_getTime = '/CookedSpecially/order/time.json?'
		_emailCheck = '/CookedSpecially/order/emailTemplatedCheck?templateName=saladdaysemailbill';
		_openFlag='/CookedSpecially/order/getOpenFlag.json?restaurantId=' + parentId;

		var deliveryArea = "";

		var searchParam = decodeURIComponent(window.location.search).substring(1);
		if (restaurantsParamMatch.test(searchParam)) {
			restaurantsParamJson = JSON.parse('{"restaurants":' + restaurantsParamMatch.exec(searchParam) + '}');
			restaurants = restaurantsParamJson.restaurants;
		}

		var isMobile = {
			Android: function() {
				return navigator.userAgent.match(/Android/i) ? true : false;
			},
			BlackBerry: function() {
				return navigator.userAgent.match(/BlackBerry/i) ? true : false;
			},
			iOS: function() {
				return navigator.userAgent.match(/iPhone|iPad|iPod/i) ? true : false;
			},
			Windows: function() {
				return navigator.userAgent.match(/IEMobile/i) ? true : false;
			},
			any: function() {
				return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Windows());
			}
		};

// Avoid `console` errors in browsers that lack a console.
// http://stackoverflow.com/questions/7585351/testing-for-console-log-statements-in-ie
		(function() {
			var method;
			var noop = function () {};
			var methods = [
				'assert', 'clear', 'count', 'debug', 'dir', 'dirxml', 'error',
				'exception', 'group', 'groupCollapsed', 'groupEnd', 'info', 'log',
				'markTimeline', 'profile', 'profileEnd', 'table', 'time', 'timeEnd',
				'timeStamp', 'trace', 'warn'
			];
			var length = methods.length;
			var console = (window.console = window.console || {});

			while (length--) {
				method = methods[length];

				// Only stub undefined methods.
				if (!console[method])
				{
					console[method] = noop;
				}
			}
		}());

		/* **********
		 * 0. PREREQUISITE checkBusinessHours
		 */

		function isOpen() {
			debugLog("DEBUG > BEGIN isOpen");
			if (alwaysOpen) {
				debugLog("DEBUG > ALWAYS OPEN");
				return true;
			}
			else if(closedToday) {
				debugLog("Closed. Come again.")
				return false;
			}
			else if(normalHour){
				// Translate your hours to UTC
				// http://www.worldtimebuddy.com/india/noida/to/gmt

				// Opening hour in UTC is 16, Closing hour is 0 the next day
				var d      = new Date(),
						open   = new Date(),
						closed = new Date();

				// Statically set UTC date for open
				open.setUTCHours(3);
				open.setUTCMinutes(30);
				open.setUTCSeconds(0);
				open.setUTCMilliseconds(0);

				// Statically Set UTC date for closing
				//closed.setUTCDate(d.getUTCDate()+1); // UTC time rotates back to 0, add a day
				closed.setUTCHours(16);
				closed.setUTCMinutes(30);
				closed.setUTCSeconds(0);
				closed.setUTCMilliseconds(0);

				// Debugging
				debugLog("user's date:" + d);
				debugLog("store open time in user's timezone:" + open);
				debugLog("store close time in user's timezone:" + closed);
				debugLog(d > open); // user's time is greater than opening time
				debugLog(d < closed); // is user's time less than closing time
				// (you don't have to go home...)

				// Test for store open?
				// Salad Days is open all week; no need to check Days
				/*
				 if (d.getDay() !== 0 && d.getDay() !== 6 && (d > open && d < closed)) {
				 //open
				 }
				 else {
				 //closed
				 }
				 */

				if (d > open && d < closed) {
					debugLog("Open for business.")
					return true;
				}
				else{
					return false;
				}

				debugLog("DEBUG > END ");
			}
		}
		/*
		 * END initHomePage
		 **********/


		/* **********
		 * 1. BEGIN initHomePage
		 * Iterates through all menus in data file and add menus to the home page
		 Function Calls
		 - addMenuToHomePage() for each menu
		 - updateAllMenus()
		 */

		function confirmOrderAndPayment(status){
//var value  = $("#popupOrderConfirmation input[name=payment]:checked").val();
			$.mobile.loading( "show" );
// Create a delay to allow the spinner to display.
			setTimeout(function(){
				if(status=="Online"){
					window.location.href=_payOnline+"restaurantId=" + restaurantId +"&checkId="+globalCheckId;
				}else{
					customerEmail = $("#popupNameAddress input#customerEmail").val().trim().toLowerCase();
					debugLog(customerEmail);
					if (customerEmail != "") {
						emailCheck(customerEmail,globalCheckId, restaurantId).then(function(){
							setTimeout(function(){$.mobile.loading( "hide" );$(".ui-fixed-hidden").removeClass("ui-fixed-hidden");$("#popupMailSent").popup( 'open' )},1000);
						});
					}
					else {
						setTimeout(function(){$.mobile.loading( "hide" );$(".ui-fixed-hidden").removeClass("ui-fixed-hidden");$("#popupEmailCOD").popup( 'open' )},1000);
					}
				}
			},0);
		}



		function getOpenFlag(){

			var getFlag=$.ajax({
				crossDomain: true,
				type: 'GET',
				url : _openFlag,
				dataType: 'json'
			})
			getFlag.then(function(data){

						if(data.status=="Always"){
							alwaysOpen=true;
						}
						else if(data.status=="Normal_Hours"){
							normalHour=true;
							$("#closedMsz").html(data.statusText);
						}
						else if(data.status=="Closed"){
							closedToday=true;
							$("#closedMsz").html(data.statusText);
						}
					},
					function(){
						alert("Please check your Internet Connection");
					}
			);

		}




		function initHomePage(restaurantId, restaurantName)
		{
			debugLog("DEBUG > BEGIN initHomePage");
			debugLog("DEBUG > About to iterate through globalData");

			if (globalData[restaurantId] != null && typeof(globalData[restaurantId].menus != "undefined") && globalData[restaurantId].menus != null) {
				// special-case the lonely menu situation
				if (restaurants.length == 1 && globalData[restaurantId].menus.length == 1) {
					initialHash = "#menu" + globalData[restaurantId].menus[0].menuId;
					updateMenuPage(restaurantId, restaurantName, 0);
					$("#restaurants").on( "pagebeforeshow", function(event, ui) {
						// do something before navigating to a new page
						if (initialHash != "#restaurants") {
							// deprecated in 1.4
							// $.mobile.changePage(initialHash, { changeHash: true });
							$.mobile.pageContainer.pagecontainer ("change", initialHash, {changeHash: true});
						}
					});
					$("#restaurants").on( "pageshow", function(event, ui) {
						// do something before navigating to a new page
						if (initialHash != "#restaurants") {
							// deprecated in 1.4
							// $.mobile.changePage(initialHash, { changeHash: true });
							$.mobile.pageContainer.pagecontainer ("change", initialHash, {changeHash: true});
						}
					});
					$("a#restaurants-button").addClass("ui-disabled");
					$("a#menu-button").addClass("ui-disabled");
					// deprecated in 1.4
					// $.mobile.changePage(initialHash, { changeHash: true });
					$.mobile.pageContainer.pagecontainer ("change", initialHash, {changeHash: true});
				}
				// general logic that allows for multiple restaurants and multiple menus
				else
				{
					var theRestaurant = $("div#restaurants div div#restaurant" + restaurantId);
					var theRestaurantOrder = $("div#order div div#restaurant" + restaurantId);
					var theMenuUl = $("div#restaurants div div#restaurant" + restaurantId + " ul");
					var theMenuOrderUl = $("div#order div div#restaurant" + restaurantId + " ul");

					if (theMenuUl.hasClass('ui-listview')) {
						theMenuUl.listview('refresh');
						debugLog("Refreshing list.");
					} else {
						theMenuUl.listview();
						debugLog("Creating list.");
					}

					// iterate through data file and create menus in homepage
					var menuIndex = 0;
					$.each(globalData[restaurantId].menus, function() {
						if (typeof(globalData[restaurantId].menus[menuIndex].menuId) != "undefined" && globalData[restaurantId].menus[menuIndex].menuId != null) {
							addMenuToHomePage(restaurantId, menuIndex);
							updateMenuPage(restaurantId, restaurantName, menuIndex);
							menuIndex++;
						}
					});

					if (theMenuUl.hasClass('ui-listview')) {
						debugLog("Refreshing list.");
						theMenuUl.listview('refresh');
					} else {
						debugLog("Creating list.");
						theMenuUl.listview();
					}

					if (theRestaurant.hasClass('ui-collapsible')) {
						debugLog("Refreshing collapsible.");
						//theMenuUl.parent().collapsible('refresh');
					} else {
						debugLog("Creating collapsible.");
						theRestaurant.collapsible();
						// worked in jqm 1.3.2, not in 1.4
						//theRestaurant.trigger('expand');
					}

					$(theRestaurant).show();
					menuIndex = 0;
					$.each(globalData[restaurantId].menus, function() {
						// create each menu page
						addMenuLinksToControlGroup(restaurantId, menuIndex);
						menuIndex++;
					});
				}
			}
			else {
				debugLog("DEBUG > globalData invalid");
			}
			getOpenFlag();
			if (!isOpen()) {
				//needs to apply both to a.addItemToOrder and span.addItemToOrder
				$(".addItemToOrder").attr('onclick', '$.mobile.pageContainer.pagecontainer ("change", "#closed", {changeHash: true});');
			}

			$("span.restaurantLink").html('<img alt="' + restaurantName + '" src="images/SD_Graphic.png"/>');

			$("#allPages").css({ "visibility": "visible" });
			$.mobile.loading( "hide" );
			$(".ui-fixed-hidden").removeClass("ui-fixed-hidden");

			$(document).on( "hashchange", function( event ) {
				//parent.postMessage("0", 'http://www.saladdays.co');
			});
			$(document).on( "pagechange", function( event ) {
				//parent.postMessage($("div#" + $.mobile.activePage.attr('id')).outerHeight(), 'http://www.saladdays.co');
			});
			//parent.postMessage(document.body.scrollHeight, 'http://www.saladdays.co');

			// Commented to avoid fb POPUP Window
			/*  $( "#popupOrderConfirmation" ).bind({

			 popupafterclose: function(event, ui) { fbShare();
			 }});  */

			debugLog("DEBUG > END initHomePage");
		}
		/*
		 * END initHomePage
		 **********/




		/*
		 *******************************************************
		 UI FUNCTIONS
		 *******************************************************
		 */


		/* **********
		 * BEGIN addItemDetailPage
		 * Creates menu item popup pages
		 Parameters:
		 m - menu index
		 s - section index
		 i - item index
		 */
		function addItemDetailPage(restaurantId, m,s,i) {
			debugLog("DEBUG > BEGIN addItemDetailPage" );

			var menuId = "menu" + globalData[restaurantId].menus[m].menuId;
			var sectionId = "section" + globalData[restaurantId].menus[m].sections[s].sectionId;
			var item = globalData[restaurantId].menus[m].sections[s].items[i];
			var price= 0;

			if (typeof(item.itemId) != "undefined" && item.itemId != null) {
				var itemId = "item" + item.itemId;
				var name = item.name;
				var description = item.description;
				var shortDescription = item.shortDescription;
				if(item.displayPrice > 0 && item.dislayPrice != item.price){
					price=item.displayPrice;
				}
				else{
					price = item.price;
				}
				var itemType = item.itemType;
				var vegetarian = item.vegetarian ? '<div class="vegetarian"></div>' : '';
				var alcoholic = item.alcoholic;
				var imageUrl = "";
				var smallImageUrl = "";

				if (description.length == 0) {
					description = shortDescription;
				}

				// cache images
				/*
				 * This design doesn't use the full-size images
				 *
				 if (typeof(item.imageUrl) != "undefined") {
				 imageUrl = item.imageUrl;
				 }
				 else {
				 imageUrl = "/static/assets/shared/images/defaultDetail50Percent.png"
				 }
				 var fullImageUrl = comCookedSpeciallyImagePrefix + imageUrl;
				 var cacheImage = document.createElement('img');
				 cacheImage.src = fullImageUrl;
				 preloadCache.push(cacheImage);
				 */
				if (typeof(item.smallImageUrl) != "undefined" && item.smallImageUrl != null) {
					smallImageUrl = item.smallImageUrl;
				}
				else {
					smallImageUrl = "/static/assets/shared/images/defaultDetail50Percent200x200.png"
				}
				var fullsmallImageUrl = comCookedSpeciallyImagePrefix + smallImageUrl;
				var cacheImage = document.createElement('img');
				cacheImage.src = fullsmallImageUrl;
				preloadCache.push(cacheImage);
				var popup = 'data-role="popup"';
				if (isPhone) {
					popup = 'data-role="page"';
				}

				var header = '<a href="#" data-rel="back" data-role="button" data-theme="d" data-icon="delete" data-iconpos="notext" class="ui-btn-left">Close</a>';
				if (isPhone) header = '' +
						'					<div data-role="header" data-id="globalHeader" data-position="fixed">' +
						'						<!-- h1><a data-role="button" href="http://www.cookedspecially.com" target="CookedSpecially">CookedSpecially</a></h1 -->' +
						'						<div class="right-controlgroup" id="options" data-role="controlgroup" data-type="horizontal" data-mini="true">' +
						'							<a id="order-button" href="#order" data-role="button" data-inline="true" data-icon="info" class="ui-disabled">My Order</a>' +
						'						</div>' +
						'					</div>';

				var footer = '' +
						'						<div data-role="content">' +
						'							<div id="options" data-role="controlgroup" data-type="horizontal" data-mini="true">' +
						'								<a href="#" onclick="goBack();" data-role="button" data-inline="true" data-icon="back" data-rel="back">Go Back</a>' +
						'								<a href="#" onclick="addItemToOrder(' + restaurantId + ',' + m + ',' + s + ',' + i + ',1000);" data-role="button" data-inline="true" data-icon="plus">Add to My Order</a>' +
						'							</div>' +
						'						</div>';
				if (isPhone) footer = '' +
						'						<div data-role="footer" data-id="globalFooter" data-position="fixed">' +
						'							<div class="footer-content">' +
						'							<div id="options" data-role="controlgroup" data-type="horizontal" data-mini="true">' +
						'								<a href="#" onclick="goBack();" data-role="button" data-inline="true" data-icon="back" data-rel="back">Go Back</a>' +
						'								<a href="#" onclick="addItemToOrder(' + restaurantId + ',' + m + ',' + s + ',' + i + ',1000);" data-role="button" data-inline="true" data-icon="plus">Add to My Order</a>' +
						'							</div>' +
						'							</div>' +
						'						</div>';

				var theItem = '' +
						'					<div ' + popup + ' id="' + itemId + 'detail" class="itemDetail" data-overlay-theme="d">' + header +
						'						<div class="itemDetailContent" data-role="content">' +
						'							<img width="200px" src="' + fullsmallImageUrl + '"/>' +
						'							<h3 class="itemDetailName">' +
						'								' + vegetarian + name + ' ' +
						'							</h3>' +
						'							<div class="itemDetailDesc">' +
						'								' + description + ' ' +
						'							</div>' +
						'							<div class="itemDetailPrice">' +
						'								' + currency + price + ' ' +
						'							</div>' +
						'						</div>' +
						footer +
						'					</div>';

				if (isPhone) {
					$(theItem).appendTo($.mobile.pageContainer);
				}
				else {
					$(theItem).appendTo("div#allPages div#" + menuId);
				}
				price = item.price;
			}
			debugLog("DEBUG > END addItemDetailPage");
		}
		/*
		 * END addItemDetailPage
		 **********/

		/* **********
		 * BEGIN addItemToOrder
		 * Adds an item to the Order page
		 Parameters:
		 m - menu index
		 s - section index
		 i - item index
		 */
		function addItemToOrder(restaurantId, m,s,i, delay)
		{
			debugLog("DEBUG > BEGIN addItemToOrder" );
			if (delay > 0) {
				$.mobile.loading( "show",
						{
							text: "Adding to Order",
							textVisible: true,
							theme: $.mobile.loader.prototype.options.theme,
							textonly: false,
							html: ""
						});
			}
			// Create a delay to allow the spinner to display.
			setTimeout(function(){
				$("a#order-button").addClass("achtung");
				var menuId = "menu" + globalData[restaurantId].menus[m].menuId;
				var sectionId = "section" + globalData[restaurantId].menus[m].sections[s].sectionId;
				var item = globalData[restaurantId].menus[m].sections[s].items[i];
				var itemId = item.itemId;
				var htmlItemId = "item" + item.itemId;
				var name = item.name;
				var description = item.description;
				var shortDescription = item.shortDescription;
				var price =0;
				if(item.displayPrice > 0 && item.dislayPrice != item.price){
					price=item.displayPrice;
				}
				else{
					price = item.price;
				}
				var itemType = item.itemType;
				var vegetarian = item.vegetarian ? '<div class="vegetarian"></div>' : '';
				var alcoholic = item.alcoholic;
				var imageUrl = "";
				var smallImageUrl = "";

				if (description.length == 0)
				{
					description = shortDescription;
				}
				if (typeof(item.smallImageUrl) != "undefined" && item.smallImageUrl != null) {
					smallImageUrl = item.smallImageUrl;
				}
				else {
					smallImageUrl = "/static/assets/shared/images/defaultDetail50Percent200x200.png"
				}
				var fullsmallImageUrl = comCookedSpeciallyImagePrefix + smallImageUrl;
				var cacheImage = document.createElement('img');
				cacheImage.src = fullsmallImageUrl;
				preloadCache.push(cacheImage);
				if ($("div#order-content div#restaurant" + restaurantId + " ul li#order-" + htmlItemId).length > 0)
				{
					var count = $("div#order-content div#restaurant" + restaurantId + " ul li#order-" + htmlItemId).attr("data-count");
					count++;
					$("div#order-content div#restaurant" + restaurantId + " ul li#order-" + htmlItemId).attr("data-count",count);
					var countContent = '<label class="countLabel" for="count">' + currency + '</label><input id="count" type="number" value="' + count + '" min="0" max="999" data-mini="true" />';
					var priceContent = '<span id="count">' + countContent + '</span>&nbsp;@&nbsp;' + currency + '<span id="displayPrice">' + price + '</span>'+'<span id="price" style="visibility:hidden;">' + item.price + '</span>';
					$("div#order-content div#restaurant" + restaurantId + " ul li#order-" + htmlItemId + " div.itemContent div.price").html(priceContent);
					price = item.price;
				}
				else
				{
					var ingredients="";
					var theItem = '' +
							'		<li id="order-' + htmlItemId + '" data-count="1">' +
							'		<img src="' + fullsmallImageUrl + '">' +
							'		<div class="itemContent ">' +
							'		    <div id="title" class="title" style="float:left;">' + vegetarian + name + ' </div>' +
							'			<div class="price" style="float:right;"><span id="count"><label class="countLabel" for="count">' + currency + '</label><div class="ui-input-text ui-body-inherit ui-corner-all ui-mini ui-shadow-inset"><input id="count" type="number" value="1" min="0" max="999" data-mini="true" /></div></span>&nbsp;@&nbsp;' + currency +'<span id="displayPrice">' + price + '</span>'+ '<span id="price" style="visibility:hidden;">' + item.price + '</span>'+'</div>'+
							'		    <div id="description" class="description longDescription">' + description + '</div>' +
							'		    <div id="description" class="description shortDescription">' + shortDescription + '</div>' +
							'			<div class="itemType" style="display:none">' + itemType + '</div>' +
							'			<div id="restaurantId" style="display:none">' + restaurantId + '</div>' +
							'			<div id="menuId" style="display:none">' + m + '</div>' +
							'			<div id="sectionId" style="display:none">' + s + '</div>' +
							'			<div id="itemId" style="display:none">' + itemId + '</div>' +
							'			<div Id="instructions" class="instructions" style="float:left; width:100%; margin-top: 5px;">'+
							'           <label style="display:none" for="special-instructions">Special instructions</label>'+
							'			<textarea id="test" maxlength="200" style="color:grey" class="ui-input-text ui-body-inherit ui-corner-all ui-mini ui-shadow-inset" style="height: 45px;" type="text"  name="instructions" placeholder="Special instructions (Note: Additional ingredients may be charged extra)" id="instructions" ></textarea></div>'+
							'		</div>' +
							'		</li>'
					var theMenuOrderUl = $("div#order-content div#restaurant" + restaurantId + " ul");
					var theCollapsible = $("div#order-content div#restaurant" + restaurantId);
					$(theCollapsible).show();
					$(theItem).prependTo(theMenuOrderUl);
					if (theMenuOrderUl.hasClass('ui-listview'))
					{
						debugLog("Refreshing list.");
						theMenuOrderUl.listview('refresh');
					} else
					{
						debugLog("Creating list.");
						theMenuOrderUl.listview();
					}

					if (theCollapsible.hasClass('ui-collapsible')) {
						debugLog("Refreshing collapsible.");
						theCollapsible.collapsible('refresh');
					} else {
						debugLog("Creating collapsible.");
						theCollapsible.collapsible();
						theCollapsible.trigger('expand');
					}
				}

				/*
				 if ( webkitContentEditing ) {
				 $("div.itemContent div.price span#count").attr("contenteditable","plaintext-only");

				 $('body').on('focus', '[contenteditable]', function() {
				 var $this = $(this);
				 $this.data('before', $this.text());
				 return $this;
				 }).on('blur keyup paste input', '[contenteditable]', function() {
				 var $this = $(this);
				 var newHTML = $this.html();
				 debugLog(newHTML);
				 newHTML = newHTML.replace(/<br>/g,"");
				 debugLog(newHTML);
				 if (newHTML.match(/^\d+$/)) {
				 debugLog("Matches: " + newHTML);
				 if ($this.data('before') !== Number(newHTML)) {
				 $this.data('before', Number(newHTML));
				 $this.trigger('change');
				 }
				 if (Number(newHTML) > 0) {
				 $this.text(Number(newHTML));
				 $this.closest("li").attr("data-count",Number(newHTML));
				 updateOrderTotals();
				 }
				 else {
				 $this.closest("li").attr("data-count","1");
				 removeItemFromOrder($this.closest("li"));
				 }
				 }
				 else {
				 debugLog("Doesn't match: " + newHTML);
				 $this.text($this.data('before'));
				 }
				 return $this;
				 });
				 }
				 */



				$( "input#count[type='number']" ).change(function()
				{
					// Check input( $( this ).val() ) for validity here
					var $this = $(this);
					var newVal = $this.val();
					debugLog(newVal);
					if (Number(newVal) > 0)
					{
						$this.val(Number(newVal));
						$this.closest("li").attr("data-count",Number(newVal));
						updateOrderTotals();
					}
					else
					{
						$this.closest("li").attr("data-count","0");
						removeItemFromOrder($this.closest("li"));
					}
				});
				updateOrderTotals();

				$(theCollapsible).show();
				$("a#order-button").removeClass("ui-disabled");
				if (isPhone) {
					//history.back();
				}
				else {
					//$( "#" + itemId + "detail" ).popup( "close" );
				}
				if (delay > 0)
				{
					//setTimeout(function(){$.mobile.loading( "hide" );$("a#order-button").removeClass("achtung");$.mobile.pageContainer.pagecontainer ("change", '#order', {changeHash: true});},1000);
					setTimeout(function(){$.mobile.loading( "hide" );$(".ui-fixed-hidden").removeClass("ui-fixed-hidden");$("a#order-button").removeClass("achtung");},delay);
				}

			},0);
			debugLog("DEBUG > END addItemToOrder");
		}
		/*
		 * END addItemToOrder
		 **********/

		$(document).ready(function() {
			$('#test').live('cut copy paste', function(e) {
				e.preventDefault();
			});
		});

		/* **********
		 * BEGIN removeItemFromOrder
		 * Adds an item to the Order page
		 Parameters:
		 m - menu index
		 s - section index
		 i - item index
		 */
		/*
		 function customiseDish(itemId)
		 {
		 var person = prompt("Please Enter Ingriedent You Want to Avoid");
		 if (person != null && person !="")
		 {
		 document.getElementById(itemId).innerHTML ="You want to avoid : <u>"+ person +"</u> ! Thanks";
		 }
		 else
		 {
		 document.getElementById(itemId).innerHTML ="Its Great! : "+"<u>"+"Complete Salad "+"</u>";
		 }
		 } */
		$(document).ready(function(){
			$("input").focus(function() {
				$(this).parent().addClass("customise Dish");
			});
		});

		function removeItemFromOrder(listItem, restaurantId, m,s,i) {
			debugLog("DEBUG > BEGIN removeItemFromOrder" );

			var count = $(listItem).attr("data-count");
			count--;
			orderItemCount--;
			orderItemCountArray[restaurantId]--;

			if (count > 0) {
				$(listItem).attr("data-count",count);
				$(listItem).find("input#count").val(count);
			}
			else {
				debugLog("******* DELETING *******");
				listItem.empty();
				listItem.remove();
			}

			if (count < 0 && count == "" && count != "NaN") {
				listItem.empty();
				listItem.remove();
			}

			updateOrderTotals();

			if (orderItemCountArray[restaurantId] < 1) {
				var theCollapsible = $("div#order-content div#restaurant" + restaurantId);
				theCollapsible.hide();
			}
			if (orderItemCount < 1) {
				$("a#order-button").addClass("ui-disabled");
				history.back();
			}

			debugLog("DEBUG > END removeItemFromOrder");
		}
		/*
		 * END removeItemFromOrder
		 **********/

		/* **********
		 * BEGIN updateOrderTotals
		 *
		 */
		var totalComp =0;
		function updateOrderTotals(){
			debugLog("DEBUG > BEGIN updateOrderTotals" );
			orderItemCount = 0;

			try{
				$("#select-delivery-area").val(chooseLocationPrompt).selectmenu('refresh');
			}
			catch (e)
			{}
			$("#popupContact div#insideDeliveryArea").css("display","block");
			$("#popupContact #continueContact").addClass("ui-disabled");
			$("#select-delivery-area-button").removeClass("achtung");
			$("#popupContact input#customerPhone").removeClass("achtung");

			overallTotal = 0;
			$.each(restaurants, function() {
				var localRestaurantId = this;
				orderItemCountArray[localRestaurantId] = 0;
				var total = 0;
				var displayTotal=0;
				$.each($("#order #order-content #restaurant" + localRestaurantId + " li"), function()
				{
					var count = Number($(this).find("input#count").val());
					if (count > 0){
						orderItemCount = orderItemCount + count;
						debugLog("orderItemCount: " + orderItemCount);
						orderItemCountArray[localRestaurantId] = orderItemCountArray[localRestaurantId] + count;
						debugLog("orderItemCountArray[this]: " + orderItemCountArray[localRestaurantId]);
						var price = Number($(this).find("span#price").text());
						var displayPrice=Number($(this).find("span#displayPrice").text());
						displayTotal=displayTotal+(count * displayPrice);
						total = total + (count * price);
						totalComp=total;
					}
				});
				overallTotal = overallTotal + total;
				$("#order #order-content #restaurant" + this + " h3 a span.ui-li-count").html(orderItemCount + " item(s) for " + currency + displayTotal.toFixed(2) + " + Tax + Delivery Charge");
			});
			debugLog("overallTotal: " + overallTotal);
			debugLog("DEBUG > END updateOrderTotals");
		}
		/*
		 * END updateOrderTotals
		 **********/

		/* **********
		 * BEGIN goBack
		 *
		 */
		function goBack() {
			debugLog("DEBUG > BEGIN goBack" );

			document.location = myHistory[myHistory.length -1];
			/*
			 history.go(-1);
			 navigator.app.backHistory();
			 $(window).on('hashchange', function() {});
			 */
			debugLog("DEBUG > END goBack");
		}
		/*
		 * END goBack
		 **********/

		/* **********
		 * BEGIN validateContactInfo
		 *
		 */
		function validateContactInfo(){
			debugLog("DEBUG > BEGIN validateContactInfo" );

			custIdParam = "";
			customerPhone = $("#popupContact input#customerPhone").val().trim().toLowerCase();
			if (phoneMatch.test(customerPhone)) {
				custIdParam = "&phone=" + customerPhone.replace(phoneClean,"");
				$("input#customerPhone").val(customerPhone.replace(phoneClean,""));
			}
			else{
				$("input#customerPhone").parent().addClass("achtung");
			}

			debugLog(custIdParam);
			if (custIdParam.length != "") {
				$("input#customerPhone").parent().removeClass("achtung");
				$("#contactContinue").removeClass("ui-disable");
				$.mobile.loading( "show" );
				// Create a delay to allow the spinner to display.
				setTimeout(function(){
					// /customer/getCustomerInfo.json?custId=<uniquedatabaseId>&email=<emailaddress>&phone=<phonenum>
					// TODO: Need to pass restaurantid in customer apis
					var custInfoUrl = _custInfo + custIdParam;
					var CustInfoPromise= $.ajax({
						url: custInfoUrl,
						contentType: "application/json; charset=utf-8",
						dataType: 'json'
					})
					CustInfoPromise.then(function (data) {
								if (data.customers[0].customerId > 0) {
									customerInfo = data.customers[0];
									customerId = data.customers[0].customerId;

									populateFormsFromCustomerInfo().then(function() {
										setDeliveryText();
									});
								}
							},
							function(){
								alert("AJAX: get customer info FAILED. " + custInfoUrl);

							});
					CustInfoPromise.complete(function() {
						debugLog("AJAX: get customer info COMPLETED");
						debugLog("About to close contact info popup");
						workflowValidated = true;
						$( "#popupContact" ).popup( "close" );
					});
				},0);

			}

			return false;
			debugLog("DEBUG > END validateContactInfo");
		}
		/*
		 * END validateContactInfo
		 *
		 **********/

		/* **********
		 * BEGIN validateNameAddress
		 *
		 */

		function validateNameAddress() {

			setAllTime();
			var emailMatch = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;
			debugLog("DEBUG > BEGIN validateNameAddress" );
			customerName = $("input#customerName").val().trim();
			customerAddress1 = $("input#customerAddress1").val().trim();
			customerAddress2 = $("input#customerAddress2").val().trim();
			customerEmail = $("input#customerEmail").val().trim();
			deliveryArea = $("#select-delivery-area-button > span").text().trim();
			debugLog("deliveryArea:" + deliveryArea);
			if (deliveryArea ==" " || deliveryArea==null){
				$("#select-delivery-area-button").addClass("achtung");
				$("input#customerAddress1").parent().addClass("achtung");
				return false;
			}
			if(deliveryArea.length < 1){
				$("input#customerAddress1").parent().addClass("achtung");
				return false;
			}
			if (customerName == "") {
				$("input#customerName").parent().addClass("achtung");
				return false;
			}
			if (customerAddress1 == "") {
				$("input#customerAddress1").parent().addClass("achtung");
				return false;
			}
			if (customerAddress2 == "" || customerAddress2.toLowerCase().indexOf("gurgaon") == -1) {
				$("input#customerAddress2").parent().addClass("achtung");
				return false;
			}
			if(customerEmail =="" ){
				$("input#customerEmail").parent().addClass("achtung");
				return false;
			}
			if(customerEmail !=""){
				if (emailMatch.test(customerEmail)) {
				}
				else{
					return false;
				}
			}
			// dunno what to validate here; probably display a confirmation popup before progressing
			$("input#customerName").parent().removeClass("achtung");
			$("input#customerAddress1").parent().removeClass("achtung");
			$("input#customerAddress2").parent().removeClass("achtung");
			debugLog("About to close Name Address popup");
			$.mobile.loading( "show" );
			// Create a delay to allow the spinner to display.
			setTimeout(function(){
				workflowValidated = true;
				$( "#popupNameAddress" ).popup( "close" );
				/* Addition end here */

			},0);
			return false;
			debugLog("DEBUG > END validateNameAddress");
		}
		/*
		 * END validateNameAddress
		 **********/
		var univDate;
		function setAllTime(){
			var val=document.getElementById("select-delivery-day").value;
			if(val=="Tomorrow"){
				displayDeliveryTime("IST","Tomorrow");
			}
			else{
				displayDeliveryTime("IST","Today");
			}
		}
		/***************************Playing with time Schedule*****************************************  */

		/*Starts ValidatingDeliveryTime   */
		/*    */
		function resetTime(){
			if(document.getElementById("select-delivery-day").value=="Today"){
				displayDeliveryTime("IST","today");
			}
			if(document.getElementById("select-delivery-day").value=="Tomorrow"){
				displayDeliveryTime("IST","tomorrow");
			}
		}

		function  setDeliveryTime(){
			debugLog("DEBUG > BEGIN validateDeliveryTime" );
			$.mobile.loading( "show" );

			var paymentStatusValue= $("#popupDeliveryTime input[name=payment]:checked").val();
			setTimeout(function(){
				var customerDeliverTime = $("#select-delivery-time").val();
				var customerEmail = $("#popupNameAddress input#customerEmail").val().trim().toLowerCase();
				var dateTimeDelivery=serverDate+" "+customerDeliverTime;
				if(customerDeliverTime!=chooseDeliveryTime &&customerDeliverTime!=null){
					// Update customer info
					customerInfo.firstName = customerName.split(' ').slice(0, -1).join(' ');
					customerInfo.lastName = customerName.split(' ').slice(-1).join(' ');
					customerInfo.address = customerAddress1;
					customerInfo.city = customerAddress2;
					customerInfo.deliveryArea=deliveryArea;
					customerInfo.deliveryTime=dateTimeDelivery;
					customerInfo.phone = customerPhone;
					customerInfo.email = customerEmail;
					//customerInfo.paymentStatus =statusValue;
					delete customerInfo.userId;
					delete customerInfo.numberOfOrders;
					delete customerInfo.createdTime;

					//setCustInfo();
					// Make sure we can't go back to the order page we're leaving now.
					myHistory.pop();
					history.replaceState({}, "CookedSpecially", initialHash);
					// deprecated in 1.4
					// $.mobile.changePage('#check', { changeHash: true });
					$.mobile.pageContainer.pagecontainer ("change", '#check', {changeHash: true});
					$.each(restaurants, function() {
						setCustInfo().then(function (){
							placeOrder(restaurantId, customerId, DELIVERY,paymentStatusValue)
							console.log("ORDERING DONE");
						});
					});
					$.mobile.loading( "hide" );
					$.mobile.pageContainer.pagecontainer ("change", '#check', {changeHash: true});
				}
			},0);
		}
		/***************************Played enough  with time Schedule*****************************************  */

		function setMessage()
		{
			$('#error_message').text('');
		}
		/*
		 * END validateDeliveryTime
		 */

		/* **********
		 * BEGIN validateDeliveryArea
		 *
		 */
		function validateDeliveryArea() {
			debugLog("DEBUG > BEGIN validateDeliveryArea" );
			deliveryArea = $("#select-delivery-area-button > span").text().trim();
			$("span#deliveryArea").text(deliveryArea);
			debugLog("deliveryArea:" + deliveryArea);

			if (deliveryArea == "" || deliveryArea == chooseLocationPrompt) {
				$("#popupContact div#insideDeliveryArea").css("display","block");
				$("#popupContact #continueContact").addClass("ui-disabled");
				$("#select-delivery-area-button").removeClass("achtung");
			}
			else {
				$("#popupContact div#insideDeliveryArea").css("display","block");
				$("#select-delivery-area-button").removeClass("achtung");
				$("#popupContact button#contactContinue").removeClass("ui-disabled");
			}
			//$('#select-delivery-area #placeholder').remove();
			debugLog("DEBUG > END validateDeliveryArea");
			return true;
		}
		/*
		 * END validateDeliveryArea
		 **********/

		/* **********
		 * BEGIN displayDeliveryAreas
		 *
		 */
		var areas = [];
		function displayDeliveryAreas(restaurantId) {
			debugLog("DEBUG > BEGIN displayDeliveryAreas");
			var delivery=[];
			if (restaurantId > 0) {

				var deliveryAreaInfoUrl = _deliveryAreaInfo + "restaurantId=" + restaurantId;
				var displayDeliveryAreaPro = $.ajax({
					crossDomain: true,
					type: 'GET',
					url: deliveryAreaInfoUrl,
					dataType: 'json'
				})
				displayDeliveryAreaPro.then(function (data) {
					var theOptions = '<option id="placeholder" data-placeholder="true" value="' + chooseLocationPrompt + '">' + chooseLocationPrompt + '</option>';
					var optionCount = 0;
					$('#select-delivery-area').addClass("ui-disabled");
					$('#select-delivery-area').html('');
					//$("#select-delivery-area-button > span").text(chooseLocationPrompt);
					$.each(data, function() {
						$("#select-delivery-area-button > span").text(chooseLocationPrompt);
						theOptions = theOptions + '<option value="' + this.name + '">' + this.name + '</option>';
						var name=this.name;
						var deliveryCharges=this.deliveryCharges;
						var minDeliveryThreshold=this.minDeliveryThreshold;
						var currentArea = this;
						currentArea.name=name;
						currentArea.deliveryCharges=deliveryCharges;
						currentArea.minDeliveryThreshold=minDeliveryThreshold;
						areas.push(currentArea);
						optionCount ++;
					});
					if (optionCount > 1) {
						$('#select-delivery-area').html(theOptions);
						$('#select-delivery-area').removeClass("ui-disabled");
						$('#select-delivery-area-button > span').removeClass("ui-disabled");
						$( "#select-delivery-area" ).change(function() {
							setTimeout(function(){
								validateDeliveryArea();
							},250);
							/*
							 $('#select-delivery-area-button > span').bind('DOMSubtreeModified', function(e) {
							 if (e.target.innerHTML.length > 0) {
							 }
							 });
							 */
						});
						$("#popupContact div#insideDeliveryArea").css("display","block");
						$("#popupContact #continueContact").addClass("ui-disabled");
						$("#select-delivery-area-button").removeClass("achtung");
					}
					else {
						$('#select-delivery-area-button').css("display","none");
						$("#select-delivery-area-button > span").text("");
						$("#popupContact #continueContact").removeClass("ui-disabled");
					}
				},function() {
					debugLog("AJAX: get delivery zone info FAILED. " + deliveryAreaInfoUrl);
				});
				displayDeliveryAreaPro.complete(function() {
					debugLog("AJAX: get delivery zone info COMPLETED");
					//setTimeout(function(){ $.mobile.loading( "hide" );$(".ui-fixed-hidden").removeClass("ui-fixed-hidden");$( "#popupContact"  ).popup( 'open' ); },1000);
				});

			}
			else {
				debugLog("ERROR: restaurantId isn't defined: " + restaurantId);
			}

			return false;
			debugLog("DEBUG > END displayDeliveryAreas");
		}



		var serverDate;
		var theOptions=null;
		function displayDeliveryTime(zone,days) {
			var defaultTime;
			var setTimeZone =_getTime+"tz="+zone+"&day="+days;

			var displayDeliveryTimePro = $.ajax({
				crossDomain: true,
				type: 'GET',
				url : setTimeZone,
				dataType: 'json'
			})
			displayDeliveryTimePro.then(function (data) {
				serverDate=data.date;
				theOptions = '<option id="placeholder" data-theme="d" data-placeholder="true" value="' + chooseDeliveryTime + '">' + chooseDeliveryTime + '</option>';
				var optionCount = 0;
				$('#select-delivery-time').html('');
				//$("#select-delivery-time-button > span").text(chooseDeliveryTime);
				for ( var i = 0; i < data.dateList.length; i++) {
					defaultTime=data.dateList[0];
					$("#select-delivery-time-button > span").text(data.dateList[0]);
					theOptions = theOptions + '<option data-theme="d" value="' + data.dateList[i] + '">' + data.dateList[i] + '</option>';
					optionCount ++;
				}
				if (optionCount >= 1) {
					$("#popupDeliveryTime button#continue").removeClass("ui-disabled");
					$('#select-delivery-time').html(theOptions);
					$('#time_warning').text('');
				}
				else {
					$("#select-delivery-time-button > span").text("Closed for Today");
					$('#time_warning').text("We are open at 9am to 10pm for TODAY. You can order for Tomorrow");
					$("#popupDeliveryTime button#continue").addClass("ui-disabled");
				}
				$("#select-delivery-time option:contains(" +defaultTime+ ")").attr('selected', 'selected');
			},function() {
				alert("AJAX: get delivery zone info FAILED. " + setTimeZone);
			});
			displayDeliveryTimePro.complete(function() {
				debugLog("AJAX: get delivery zone info COMPLETED");
				//setTimeout(function(){ $.mobile.loading( "hide" );$(".ui-fixed-hidden").removeClass("ui-fixed-hidden");$( "#popupContact"  ).popup( 'open' ); },1000);
			});
			return false;
			debugLog("DEBUG > END displayDeliveryAreas");
		}

		function checkTime(){
			var val =$('#select-delivery-time').val();
			if(val==''|| val==chooseDeliveryTime){
				$('#time_warning').text("please select time below");
				$("#popupDeliveryTime button#continue").addClass("ui-disabled");
			}
			else{
				$('#time_warning').text('');
				$("#popupDeliveryTime button#continue").removeClass("ui-disabled");
			}
		}

		/* setting Charges on select  */
		function setDeliveryText(){

			$.each(areas, function() {
				var currentArea = this;
				if (currentArea.name==$("#select-delivery-area option:selected").text()) {
					if(currentArea.deliveryCharges!=0 && totalComp<currentArea.minDeliveryThreshold){
						$('#Charges_message').text('A delivery charge of Rs. '+currentArea.deliveryCharges+' is applicable on your address');
					}
					else{
						$('#Charges_message').text("");
					}
				}
				else if($("#select-delivery-area option:selected").text()=="" || $("#select-delivery-area option:selected").text()=="Choose a delivery location"){
					$('#Charges_message').text("");
				}
			});
		}

		/* **********
		 * BEGIN setCustInfo
		 *
		 */
		function setCustInfo() {
			debugLog("DEBUG > BEGIN setCustInfo" );
			var deferred = $.Deferred();
			$.mobile.loading( "show" );

			var jsonString = JSON.stringify(customerInfo);

			$.ajax({
				type: "POST",
				contentType:"application/json; charset=utf-8",
				url: _setCustInfo,
				data: jsonString,
				success : function(data) {

					if(data.status=="success"){
						deferred.resolve();
					}
					else if(data.status=="fail"){
						debugLog("AJAX: customerUpdate FAILED. " + _setCustInfo + " " + jsonString);
						console.log("AJAX: customerUpdate FAILED. " + _setCustInfo + " " + jsonString);
						alert("Sorry please place order again !")
					}
				},
				error : function() {
					debugLog("AJAX: customerUpdate FAILED. " + _setCustInfo + " " + jsonString);
					console.log("AJAX: customerUpdate FAILED. " + _setCustInfo + " " + jsonString);

				}
			});

			return deferred.promise();
			debugLog("DEBUG > END setCustInfo");
		}
		/*
		 * END setCustInfo
		 **********/

		/* **********
		 * BEGIN validateEmailForCheck
		 *
		 */
		/* var globalCheckId=null;
		 function validateEmailForCheck() {
		 debugLog("DEBUG > BEGIN validateContactInfo" );
		 var emailMatch = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;
		 var phoneMatch = /^[0-9.-]+$/;
		 var phoneClean = /[.-]/g;
		 var custIdParam = "";
		 customerEmail = $("#popupEmail input#customerEmail").val().trim().toLowerCase();
		 if (customerEmail == "") {
		 $("#popupEmail input#customerEmail").parent().addClass("achtung");
		 return false;
		 }
		 if (emailMatch.test(customerEmail)) {
		 custIdParam = customerEmail;
		 }
		 else {
		 $("#popupEmail input#customerEmail").parent().addClass("achtung");
		 return false;
		 }

		 $.mobile.loading( "show" );
		 // Create a delay to allow the spinner to display.
		 setTimeout(function(){
		 // Update customer info with email
		 customerInfo.email = customerEmail;
		 setCustInfo();

		 if (custIdParam.length != 0) {
		 // Make sure we can't go back to the order page we're leaving now.
		 //myHistory.pop();
		 //history.replaceState({}, "CookedSpecially", initialHash);

		 $.each(restaurants, function() {
		 var checkId = $("#check #restaurant" + this + " #checkId").text();

		 debugLog("restaurantId: " + this + " checkId: " + checkId);
		 if (checkId.length > 0) {
		 debugLog("Email validated - custIdParam: " + custIdParam + " checkId: " + checkId);
		 emailCheck(custIdParam, checkId, this).then(function(){
		 $( "#popupEmail" ).popup( "close" );
		 $("#popupOrderConfirmation").popup( 'open');
		 },
		 function (){  $("#popupEmail input#customerId").parent().addClass("achtung"); }
		 );

		 }
		 });
		 /*  $( "#popupEmail" ).popup( "close" );
		 $("#popupOrderConfirmation").popup( 'open'); */
		/*    }
		 else {
		 $("#popupEmail input#customerId").parent().addClass("achtung");
		 }
		 $.mobile.loading( "hide" );
		 },0);
		 return false;
		 debugLog("DEBUG > END validateEmailForCheck");
		 }

		 */
		/*
		 function validateCODEmailForCheck() {
		 debugLog("DEBUG > BEGIN validateContactInfo" );
		 var emailMatch = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;
		 var phoneMatch = /^[0-9.-]+$/;
		 var phoneClean = /[.-]/g;
		 var custIdParam = "";
		 customerEmail = $("#popupEmailCOD input#customerEmail").val().trim().toLowerCase();
		 if (customerEmail == "") {
		 $("#popupEmailCOD input#customerEmail").parent().addClass("achtung");
		 return false;
		 }

		 if (emailMatch.test(customerEmail)) {
		 custIdParam = customerEmail;
		 }
		 else {
		 $("#popupEmailCOD input#customerEmail").parent().addClass("achtung");
		 return false;
		 }

		 $.mobile.loading( "show" );
		 // Create a delay to allow the spinner to display.
		 setTimeout(function(){
		 // Update customer info with email
		 customerInfo.email = customerEmail;
		 setCustInfo();

		 if (custIdParam.length != 0) {
		 // Make sure we can't go back to the order page we're leaving now.
		 //myHistory.pop();
		 //history.replaceState({}, "CookedSpecially", initialHash);

		 $.each(restaurants, function() {
		 var checkId = $("#check #restaurant" + this + " #checkId").text();
		 debugLog("restaurantId: " + this + " checkId: " + checkId);
		 if (checkId.length > 0) {
		 debugLog("Email validated - custIdParam: " + custIdParam + " checkId: " + checkId);
		 emailCheck(custIdParam, checkId, this).then(function() {
		 $( "#popupEmailCOD" ).popup( "close" );
		 $("#popupMailSent").popup( 'open');
		 },
		 function () {
		 $("#popupEmailCOD input#customerId").parent().addClass("achtung");
		 });

		 }
		 });
		 /* $( "#popupEmailCOD" ).popup( "close" );
		 $("#popupMailSent").popup( 'open'); */
		/*   } */
		/* else {
		 $("#popupEmailCOD input#customerId").parent().addClass("achtung");
		 }
		 $.mobile.loading( "hide" );
		 },0);
		 return false;
		 debugLog("DEBUG > END validateEmailForCheck");
		 }  */
		/*
		 * END validateEmailForCheck
		 **********/

		/***********
		 * BEGIN populateFormsFromCustomerInfo
		 */

		function populateFormsFromCustomerInfo() {
			debugLog('populateFormsFromCustomerInfo()');
			var deferred = $.Deferred();
			/*
			 "customerId":25,
			 "restaurantId":null,
			 "userId":null,
			 "firstName":null,
			 "lastName":null,
			 "address":null,
			 "city":null,
			 "phone":null,
			 "email":"ewchampion@yahoo.com",
			 "numberOfOrders":null,
			 "createdTime":1386895735000
			 */

			var customerName = "";
			var address = "";
			var city = "";
			var email = "";

			if (customerInfo.firstName != null && customerInfo.lastName != null && customerInfo.firstName != "" && customerInfo.lastName != "") {
				customerName = customerInfo.firstName + " " + customerInfo.lastName;
				debugLog(customerName);
				$("input#customerName").val(customerName);
			}
			else{
				$("input#customerName").val("");
			}
			if (customerInfo.address != null && customerInfo.address != "") {
				address = customerInfo.address;
				debugLog(address);
				$("input#customerAddress1").val(address);
			}
			else{
				$("input#customerAddress1").val("");
			}
			if (customerInfo.city != null && customerInfo.city != "") {
				// Hardcoded to Gurgaon, Haryana
				//city = customerInfo.city;
				//debugLog(city);
				//$("input#customerAddress2").val(city);
			}
			if (customerInfo.email != null && customerInfo.email != "") {
				email = customerInfo.email;
				debugLog(email);
				$("input#customerEmail").val(email);
			}
			else{
				$("input#customerEmail").val("");
			}
			var areaCount=0;
			if (customerInfo.deliveryArea != null && customerInfo.deliveryArea != "") {
				deliveryArea = customerInfo.deliveryArea;
				debugLog(deliveryArea);
				/* $("select#select-delivery-area option[value=\"" + deliveryArea + "\"]").prop('selected', true);
				 $("div#select-delivery-area-button span").text(deliveryArea); */
				$.each(areas, function() {
					var currentArea = this;

					if (currentArea.name==customerInfo.deliveryArea) {
						areaCount++;
						$("#select-delivery-area-button > span").text(customerInfo.deliveryArea);
						$("#select-delivery-area option:contains(" +customerInfo.deliveryArea+ ")").attr('selected', 'selected');
					}
				});

				deferred.resolve();
				//setDeliveryText();
			}
			else{
				$("#select-delivery-area-button > span").text(chooseLocationPrompt);
				$("#select-delivery-area option:contains(" +chooseLocationPrompt+ ")").attr('selected', 'selected');
				$("#select-delivery-area-button").addClass("achtung");
			}
			if(areaCount==0){
				$("#select-delivery-area-button > span").text(chooseLocationPrompt);
				$("#select-delivery-area option:contains(" +chooseLocationPrompt+ ")").attr('selected', 'selected');
				$("#select-delivery-area-button").addClass("achtung");
			}
			return deferred.promise();
		}
		/*
		 * END populateFormsFromCustomerInfo
		 **********/


		/***********
		 * BEGIN emailCheck
		 */
		/* function emailCheck(email, checkId, restaurantId) {
		 debugLog('emailCheck()');
		 var deferred = $.Deferred();
		 // /order/emailCheck?checkId=<checkId>&email=<target email>&restaurantId=<restaurantId>
		 // /order/emailTemplatedCheck?email=akshay.madan@gmail.com&templateName=saladdaysemailbill&checkId=6

		 $.mobile.loading( "show" );
		 // Create a delay to allow the spinner to display.
		 setTimeout(function(){
		 if (email != "" && checkId > 0 && restaurantId > 0) {
		 var url = _emailCheck +
		 "&checkId=" + checkId +
		 "&email=" + email;

		 var emailCheckPro =	$.ajax({
		 url: url
		 })
		 emailCheckPro.then(function (data) {
		 //$('#email-check').html('Email Sent');
		 debugLog("AJAX: emailCheck() Success");
		 deferred.resolve();
		 $("#emailcheck-button").hide();
		 },function() {
		 // This API continually throws a 500 error. We need to debug and fix it.
		 alert("Please resend check to your email address");
		 debugLog("AJAX: emailCheck() FAILED. " + url);
		 });
		 emailCheckPro.complete(function() {
		 debugLog("AJAX: emailCheck() COMPLETED");
		 });
		 }
		 },0);
		 return deferred.promise();
		 } */
		/*
		 * END emailCheck
		 **********/


		/***********
		 * BEGIN placeOrder
		 */

		var priceOnCheck;
		function placeOrder(restaurantId, customerId, destinationType,paymentStatusValue){
			debugLog("DEBUG > BEGIN placeOrder(" + restaurantId +")");
			/*
			 {"checkId":98,"table":1,"time":"","price":815,"items":[{"id":175,"name":"Shrimp with Citrus Sala","price":325,"smallImageUrl":"/static/1/175_Shrimp-Shrimp-Salad200x200.jpg"},{"id":178,"name":"Greek Village Salad","price":245,"smallImageUrl":"/static/1/178_178_Greek_Village_Salad200x200.JPG"},{"id":178,"name":"Greek Village Salad","price":245,"smallImageUrl":"/static/1/178_178_Greek_Village_Salad200x200.JPG"}]}
			 */
			var getCheckUrl = _getCheck + "restaurantId=" + restaurantId + "&custId=" + customerId;
			var placeOrderPro = $.ajax({
				url: getCheckUrl,
				dataType: 'json'
			})
			placeOrderPro.then(function (data){
				debugLog("DEBUG > CheckID (" + data.checkId +"), Check Value (" + data.price +"), and customerID (" + customerId +")");
				if (data.price > 0) {
					debugLog("DEBUG > We did not close the older check properly. Something that we should check for this CheckID (" + data.checkId +") and customerID (" + customerId +")");
					var statusApi = comCookedSpeciallyApiPrefix + "/order/setCheckStatus?checkId=" + checkId + "&status=Unpaid";
					var statusPro = $.ajax(statusApi, {
						isLocal: false,
						async: false
					})
					statusPro.then(function (data){
						debugLog("ajax success: " + statusApi);
						debugLog(JSON.stringify(data));
						placeOrder(restaurantId, customerId, destinationType);
					},function() {
						alert("ajax error: " + statusApi);
					});
					statusPro.complete(function() {
						debugLog("ajax complete: " + statusApi);
					});
					return;
				}

				var jsonOrder = JSON.parse('{"checkId":' + data.checkId + ',"cust":' + customerId + ',"time":"","price":0,"items":[]}'); // Need to set sourceType and destinationType

				$.each($("#order #order-content #restaurant" + restaurantId + " div ul li"), function() {
					var itemCount = $(this).attr("data-count");
					var itemContent = $(this).children("div.itemContent").children();
					var smallImageUrl = $(this).children("img").attr("src");
					var id = itemContent.filter("div#itemId").text();
					var name = itemContent.filter("div#title").text();
					var price = itemContent.filter("div.price").children("span#price").text();
					var instructions=itemContent.filter("div.instructions").children("#test").val();
					var itemType = itemContent.filter("div.itemType").text();
					var item = JSON.parse('{"id":' + id + ', "name":"' + name + '","price":' + price + ',"smallImageUrl":"' + smallImageUrl + '","dishType":"' + itemType + '","instructions":"'+instructions +'"}');
					jsonOrder.price = jsonOrder.price + price;

					for (i = 0; i < itemCount; i++) {
						jsonOrder.items.push(item);
					}
				});
				var jsonString = JSON.stringify(jsonOrder);

				if (jsonOrder.items.length > 0) {

					var addToCheck=_addToCheck+"paymentStatus=" + paymentStatusValue;

					var addToCheckPro = $.ajax({
						type: "POST",
						contentType:"application/json; charset=utf-8",
						url: addToCheck,
						data: jsonString
					})
					addToCheckPro.then(function (data) {
						// expected return:
						//{"orderId":1,"checkId":1,"restaurantId":1,"tableId":1,"error":"Error message","status":"Failed|Success"}
						if (data.status=="Online"){
							// Empty out the order that we submitted to get here
							$("a#order-button").addClass("ui-disabled");
							$("div#order-content div#restaurant" + restaurantId + " ul").empty();
							var theCollapsible = $("div#order-content div#restaurant" + restaurantId);
							theCollapsible.hide();
							setCheckType(data.checkId, destinationType).then(function(){
								confirmOrderAndPayment(data.status);
							});
							globalCheckId=data.checkId;
						}
						else if (data.status=="COD"){
							// Empty out the order that we submitted to get here
							$("a#order-button").addClass("ui-disabled");
							$("div#order-content div#restaurant" + restaurantId + " ul").empty();
							var theCollapsible = $("div#order-content div#restaurant" + restaurantId);
							theCollapsible.hide();
							setCheckType(data.checkId, destinationType).then(function(){
								displayCheckFromAPI(restaurantId, customerId,data.checkId, data);
								setTimeout(function(){$.mobile.loading( "hide" );$(".ui-fixed-hidden").removeClass("ui-fixed-hidden");$("#popupMailSent").popup( 'open' )},1000);
							});
							globalCheckId=data.checkId;
						}
						else if ( data.status == "Failed"){
							alert("We're sorry, but we've encountered an error: " + data.checkId +
									"\n Check Id: " + data.checkId );
						}else{
							alert("We're sorry, but we've encountered an error.")
						}
					},function() {
						alert("AJAX: Add to check FAILED. " + _addToCheck + " " + jsonString);
					});
					addToCheckPro.complete(function() {
						debugLog("AJAX: Add to check COMPLETED");
					});
				}

				debugLog("checkId " + data.checkId);
				debugLog("customerId " + customerId);

			},function() {
				alert("AJAX: getCheckPreview() FAILED. " + getCheckUrl);
			});
			placeOrderPro.complete(function() {
				debugLog("AJAX: getCheckPreview() COMPLETED");
			});

			debugLog("DEBUG > END placeOrder(" + restaurantId +")");
		}
		/*
		 * END placeOrder
		 **********/

		/***********
		 * BEGIN getCheck
		 */
		function getCheck(restaurantId, customerId, checkId,data){
			debugLog("DEBUG > BEGIN getCheck(" + restaurantId +")");
			displayCheckFromAPI(restaurantId, customerId, checkId, data);
			debugLog("DEBUG > END getCheck(" + restaurantId +")");
		}
		/*
		 * END getCheck
		 **********/

		/***********
		 * BEGIN setCheckType
		 */
		function setCheckType(checkId, type) {
			debugLog("DEBUG > BEGIN setCheckType");
			var deferred = $.Deferred();

			var typeApi = comCookedSpeciallyApiPrefix + "/order/setCheckType?checkId=" + checkId + "&type=" + type;

			var setCheckTypePro = $.ajax(typeApi, {
				isLocal: false
			})
			setCheckTypePro.then(function (data) {
				debugLog("ajax success: " + typeApi);
				deferred.resolve();
				debugLog(JSON.stringify(data));
			},function() {
				alert("ajax error: " + typeApi);
				deferred.reject();
			});
			setCheckTypePro.complete(function() {
				debugLog("ajax complete: " + typeApi);
			});
			return deferred.promise();
		}

// From Shashank
		function zeroFill( number, width ){
			width -= number.toString().length;
			if ( width > 0 ){
				return new Array( width + (/\./.test( number ) ? 2 : 1) ).join( '0' ) + number;
			}
			return number + ""; // always return a string
		}

		/* **********
		 * BEGIN displayCheckFromAPI
		 * Creates the home page with all the checks
		 Parameters:
		 */
		function displayCheckFromAPI(restaurantId, customerId, checkId, data) {
			debugLog("DEBUG > BEGIN displayCheck: " + checkId);

			//http://www.cookedspecially.com:8080/CookedSpecially/order/generateCheckForPrint?templateName=saladdaysbill&checkId=193
			var generateCheckApi = comCookedSpeciallyApiPrefix + "/order/generateCheckForPrint?templateName=saladdaysbill&checkId=" + checkId;
			var displayCheckPro = $.ajax(generateCheckApi,{
				isLocal: false
			})
			displayCheckPro.then(function (data){
				debugLog("ajax success: " + generateCheckApi);
				debugLog(JSON.stringify(data));

				var theCheckIdForEmail = '<div style="display:none" id="checkId">' + checkId + '</div>';
				$(theCheckIdForEmail).appendTo("#check-content #restaurant" + restaurantId);
				var theCheck = '' +
						'<div id="check' + checkId + '" class="ui-li ui-li-static ui-btn-up-c">' +
						'</div>';
				$(theCheck).appendTo("#check-content #restaurant" + restaurantId);
				$(data).appendTo("#check-content #restaurant" + restaurantId);
				var now = new Date();
				$('#date-time').text(zeroFill(now.getDate(), 2) + '/' + zeroFill((now.getMonth()+1),2) + '/' + now.getFullYear() + ' ' + zeroFill(now.getHours(),2) + ':' + zeroFill(now.getMinutes(),2));

				$("#check-content #restaurant" + restaurantId).show();
				/* customerEmail = $("#popupEmail input#customerEmail").val().trim().toLowerCase();
				 debugLog(customerEmail); */


				var tableObject = $('#checkData tr').map(function(i) {
					$(this).find('td').each(function(i) {
						priceOnCheck=$(this).text();
					});
				}).get();
				$("#openMsz").text("Rs "+priceOnCheck);
				setTimeout(function(){$.mobile.loading( "hide" );$(".ui-fixed-hidden").removeClass("ui-fixed-hidden");$("#popupOrderConfirmation").popup( 'open' )},1000);
			},function() {
				alert("ajax error: " + generateCheckApi);
			});
			displayCheckPro.complete(function() {
				debugLog("ajax complete: " + generateCheckApi);
			});

			debugLog("DEBUG > END displayCheckFromAPI");
		}
		/*
		 * END displayCheckFromAPI
		 **********/

		/* **********
		 * BEGIN displayCheck
		 * Creates the home page with all the checks
		 Parameters:
		 */
		function displayCheck(restaurantId, customerId, checkId, data) {
			debugLog("DEBUG > BEGIN displayCheck: " + checkId);
			var checkId = data.checkId;
			var additionalChargesName1 = data.additionalChargesName1;
			var additionalChargesName2 = data.additionalChargesName2;
			var additionalChargesName3 = data.additionalChargesName3;
			total = data.bill + data.additionalChargesValue1 + data.additionalChargesValue2 + data.additionalChargesValue3;

			var d=new Date();

			var theCheck = '' +
					'<div id="check' + checkId + '" class="ui-li ui-li-static ui-btn-up-c">' +
					'<h4 id="status" class="ui-li-desc">' +
					'	Check #<span id="checkId">' + checkId + '</span> Printed @ '+ d.toLocaleTimeString() +

					'</h4>' +
					'</div>';
			$(theCheck).appendTo("#check-content #restaurant" + restaurantId);

			$.each(data.orders, function() {
				$.each(this.orderDishes, function() {
					var name = this.name;
					var quantity = this.quantity;
					var price = this.price;
					var theItem = '<strong>' + name + '</strong> ' + quantity + ' @ ' + currency + price + '<br/>';
					$(theItem).appendTo("#check-content #restaurant" + restaurantId);
				});
			});

			var theAdditions = '<br/>';
			if (additionalChargesName1 && additionalChargesName1.length > 0) {
				theAdditions = theAdditions + '<strong>' + additionalChargesName1 + ': </strong> ' + currency + data.additionalChargesValue1.toFixed(2) + '<br/>';
			}
			if (additionalChargesName2 && additionalChargesName2.length > 0) {
				theAdditions = theAdditions + '<strong>' + additionalChargesName2 + ': </strong> ' + currency + data.additionalChargesValue2.toFixed(2) + '<br/>';
			}
			if (additionalChargesName3 && additionalChargesName3.length > 0) {
				theAdditions = theAdditions + '<strong>' + additionalChargesName3 + ': </strong> ' + currency + data.additionalChargesValue3.toFixed(2) + '<br/>';
			}

			$(theAdditions).appendTo("#check-content #restaurant" + restaurantId);


			var theSummary = '<br/><strong>Total: </strong> ' + currency + total.toFixed(2) + '<br/>';

			$(theSummary).appendTo("#check-content #restaurant" + restaurantId);

			$("#check-content #restaurant" + restaurantId).show();
			//setTimeout(function(){$.mobile.loading( "hide" );$(".ui-fixed-hidden").removeClass("ui-fixed-hidden");},1000);

			debugLog("DEBUG > END displayCheck");
		}
		/*
		 * END displayCheck
		 **********/

		/*
		 *******************************************************
		 DATA FUNCTIONS
		 *******************************************************
		 */

		/***********
		 * BEGIN updateAjaxDataRemote
		 */
		function updateAjaxDataRemote(restaurantId, restaurantName) {
			debugLog("DEBUG > BEGIN updateAjaxDataRemote");
			var deferredObject = $.Deferred();
			var comCookedSpeciallyMenuApi = comCookedSpeciallyApiPrefix + "/menu/getallmenusjson/" + restaurantId;
			debugLog( 'Using API: ' + comCookedSpeciallyMenuApi );

			if (navigator.onLine) {
				var updateAjaxDataPro = $.ajax(comCookedSpeciallyMenuApi, {
					isLocal: false
				})
				updateAjaxDataPro.then(function (data) {
					if( console && debugLog ) {
						debugLog("ajax success: " + comCookedSpeciallyMenuApi);
						globalDataString = JSON.stringify(data);
						debugLog(globalDataString);
					}

					globalData[restaurantId] = JSON.parse(globalDataString);
					deferredObject.resolve();

				},function() {
					alert("ajax error: " + comCookedSpeciallyMenuApi);
				});
				updateAjaxDataPro.complete(function() {
					debugLog("ajax complete: " + comCookedSpeciallyMenuApi);
				});
			}
			else {
				debugLog("ajax error: offline");
				if (confirm(strOfflineAlert)) {
					updateAjaxDataRemote();
				}
			}
			return deferredObject.promise();
			debugLog("DEBUG > END updateAjaxDataRemote");
		}
		/*
		 * END updateAjaxDataRemote
		 **********/

		/***********
		 * BEGIN updateRestaurantInfo
		 */
		function updateRestaurantInfo(restaurantId) {
			debugLog("DEBUG > BEGIN updateRestaurantInfo");

			orderItemCountArray[restaurantId] = 0;
			var comCookedSpeciallyRestaurantApi = comCookedSpeciallyApiPrefix + "/restaurant/getrestaurantinfo?restaurantId=" + restaurantId;
			debugLog( 'Using API: ' + comCookedSpeciallyRestaurantApi );

			var updateRestaurantInfoPro = $.ajax(comCookedSpeciallyRestaurantApi,{
				isLocal: false
			})
			updateRestaurantInfoPro .then(function (data) {
				if( console && debugLog ) {
					debugLog("ajax success: " + comCookedSpeciallyRestaurantApi);
					var restaurantDataString = JSON.stringify(data);
					debugLog(restaurantDataString);
				}

				restaurantData[restaurantId] = JSON.parse(restaurantDataString);

				// TODO: Look for parent email id and use that in cutsomer info apis instead of restaurandId
				//outCircleDeliveryCharges = restaurantData[restaurantId].outCircleDeliveryCharges;

				if (restaurantData[restaurantId].currency == "INR") {
					currency = '';
				}
				if (restaurantData[restaurantId].currency == "USD") {
					currency = '$';
				}
				if (restaurantData[restaurantId].country == "GBP") {
					currency = '';
				}
				if (restaurantData[restaurantId].country == "EUR") {
					currency = '';
				}
				if (restaurantData[restaurantId].country == "JPY") {
					restaurantData[restaurantId].country = "";
					currency = '';
				}

				var theHtml = '' +
						'<div class="restaurant-check-content" id="restaurant' + restaurantId + '" data-collapsed="false" style="display:none">' +
						'	<h3>' +
						'		' + restaurantData[restaurantId].businessName +
						'	</h3>' +
						'	<ul data-role="listview" data-inset="true"></ul>' +
						'</div>';
				$(theHtml).appendTo("div#restaurants div#restaurants-content");
				theHtml = '' +
						'<div class="restaurant-check-content" id="restaurant' + restaurantId + '" data-collapsed="false" style="display:none">' +
						'	<h3>' +
						'		<span class="ui-li-count">' + currency + '0.00' + '</span>' +
						'	</h3>' +
						'	<ul data-role="listview" data-inset="true"></ul>' +
						'</div>';
				$(theHtml).appendTo("div#order div#order-content");

				if (restaurantData[restaurantId].businessLandscapeImageUrl != null && restaurantData[restaurantId].businessLandscapeImageUrl.length > 0)
				{
					//$("div#restaurants div#restaurant" + restaurantId).css('background-image', 'url(' + restaurantData[restaurantId].businessLandscapeImageUrl + ')').css('background-size', 'cover');
				}
				if (restaurantData[restaurantId].businessName != null && restaurantData[restaurantId].businessName.length > 0) {
					restaurantName = restaurantData[restaurantId].businessName;
					$("div#restaurants div#restaurant" + restaurantId + " h3 span.ui-btn-text").text(restaurantName);
					$(".restaurantName .restaurantLink").text(restaurantName);
					document.title = restaurantName;
				}

				var restaurantCheckHeader = '' +
						'<div id="restaurant' + restaurantId + '" style="display:none;">' +
						'</div>';
				$(restaurantCheckHeader).appendTo("#check-content");

				$( "div#order" ).on( "pagebeforeshow", function( event ) {
					displayDeliveryAreas(restaurantId);
				} );
				updateAjaxDataRemote(restaurantId, restaurantData[restaurantId].businessName).then(function (){
					initHomePage(restaurantId, restaurantName);
				});
			},function() {
				alert("ajax error: " + comCookedSpeciallyRestaurantApi);

			});
			updateRestaurantInfoPro.complete(function() {
				debugLog("ajax complete: " + comCookedSpeciallyRestaurantApi);
			});

			debugLog("DEBUG > END updateRestaurantInfo");
		}
		/*
		 * END updateRestaurantInfo
		 **********/

		/*
		 * http://stackoverflow.com/questions/11832914/round-up-to-2-decimal-places-in-javascript
		 * var n = 1.7777;
		 * n.round(2); // 1.78
		 */
		Number.prototype.round = function(places) {
			return +(Math.round(this + "e+" + places)  + "e-" + places);
		}

		/***********
		 * BEGIN reset
		 */
		function reset(){
			$("a#done-button").addClass("ui-disabled");

			myHistory.pop();
			history.replaceState({}, "CookedSpecially", initialHash);

			if ( window.self === window.top ) {
				//not in a frame
				customerId = "";
				customerEmail = "";
				customerPhone = "";
				$("input#customerEmail").val("");
				$("input#customerPhone").val("");
				$("input#customerName").val("");
				$("input#customerAddress1").val("");
				$("input#customerAddress2").val("");
				//alert("Thank you. Your order is complete and you have been logged out.");
				window.location.assign(initialURL);
			}
			else {
				//alert("Thank you. Your order is complete.");
				window.location.assign(initialURL);
			}

		}
		/*
		 * END reset
		 **********/

		/***********
		 * BEGIN debugLog
		 */
		function debugLog(msg){

			if (debug) {
				console.log(msg);
			}
		}
		/*
		 * END debugLog
		 **********/

		/*
		 *******************************************************
		 MAIN PROGRAM
		 *******************************************************
		 */
		var startTime = new Date().getTime();

		$.ajaxSetup({
			async: false,
			cache: false
		});

//http://stackoverflow.com/questions/13986182/how-can-i-improve-the-page-transitions-for-my-jquery-mobile-app/13986390#13986390
		$(document).one("mobileinit", function () {
			$.mobile.ajaxEnabled = true;
			$.mobile.allowCrossDomainPages = true;
			$.mobile.autoInitializePage = false;
			$.mobile.defaultPageTransition = "none";
			$.mobile.loader.prototype.options.text = "loading";
			$.mobile.loader.prototype.options.textVisible = true;
			$.mobile.mobile.touchOverflowEnabled = true;
			$.mobile.pageContainer = $("#allPages");
			$.mobile.phonegapNavigationEnabled = true;
		});

		$(document).ready(function(){
			// When the document is ready, Cordova isn't
			$.mobile.loading( "show", {
				text: "Loading...",
				textVisible: true,
				theme: $.mobile.loader.prototype.options.theme,
				textonly: false,
				html: ""
			});

			$(window).on('hashchange', function() {myHistory.push(document.location.hash)});

			$.each(restaurants, function() {
				updateRestaurantInfo(this);
			});

		});
// END: document.ready()

		$( document ).on( "pageinit", function() {
			$( '#popupContact' ).on({
				popupafterclose: function() {
					$("input#customerId").parent().removeClass("achtung");
				}
			});
			$("div#order").on( "pageshow", function(event, ui) {
				updateOrderTotals();
				//Refresh the FB button state if using the XHMTL version
				//FB.XFBML.parse();
			});

			// Set up the nested popups for the ordering workflow
			$( "#popupContact" ).bind({
				popupafterclose: function(event, ui) {
					debugLog("Initial Contact Info popup closed");
					if (workflowValidated) {
						workflowValidated = false;
						$( "#popupNameAddress" ).popup( "open" );
					}
					$.mobile.loading( "hide" );
				}
			});
			$( "#popupNameAddress" ).bind({
				popupafterclose: function(event, ui) {
					debugLog("Name Address popup closed");
					if (workflowValidated) {
						workflowValidated = false;
						$( "#popupDeliveryTime" ).popup( "open" );
					}
					$.mobile.loading( "hide" );
				}
			});

			$( "#popupDeliveryTime" ).bind({
				popupafterclose: function(event, ui) {
					debugLog("Name Address popup closed");
					if (workflowValidated) {
						workflowValidated = false;
						$( "#popupOrderConfirmation" ).popup( "open" );
					}
					$.mobile.loading( "hide" );
				}
			});
			$( "#popupEmail" ).bind({
				popupafterclose: function(event, ui) {
					debugLog("popup Email close");
					if (workflowValidated) {
						workflowValidated = false;
						$( "#popupOrderConfirmation" ).popup( "open" );
					}
					$.mobile.loading( "hide" );
				}
			});

			$("div#check").on( "pageshow", function(event, ui) {
				$.mobile.loading( "show" );
			});
			$("div#check").on( "pagebeforehide", function(event, ui) {
				// clear check data and reset the app
				reset();
			});

			$( window ).on( "navigate", function( event, data ) {
				try {
					ga('send', 'pageview');
				}catch(ex){}
			});
		});

		/*
		 * http://css-tricks.com/forums/discussion/16123/reload-jquery-functions-on-ipad-orientation-change/p1
		 * http://www.ibm.com/developerworks/library/mo-jquery-mobile-api/
		 */
		$('body').bind('orientationchange', function(event) {
			debugLog('orientationchange: '+ event.orientation);
		});

//$('body').trigger('orientationchange');

	} catch (error) {
		console.error("Your javascript has an error: " + error);
	}

</script>
